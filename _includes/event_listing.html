{%- assign start = site.data.startdate | date: "%s" | plus: 0 -%}
{%- assign order = 0 -%}
{%- assign whens = "" | split: "" -%}
{%- if event.when.first -%}
  {%- for when in event.when -%}
    {%- assign nwhen = when | date: "%s" | plus: 0 -%}
    {%- if nwhen > start -%}
      {%- assign whens = whens | push: when -%}
    {%- endif -%}
  {%- endfor -%}
  {%- for when in whens -%}
    {%- assign date = when | date: "%s" | plus: 0 -%}
    {%- if date > start and (order == 0 or date < order) -%}
      {%- assign order = date -%}
    {%- endif -%}
  {%- endfor -%}
{%- endif -%}

<!-- <div>Whens: {{ whens }}</div>
<div>event.when: {{ event.when | join: ', ' }}</div> -->

<div class="listing" {% if event.when.first %}data-dates="{{ event.when | join: ' ' }}"{% endif %} style="order: {{order}};">
  <div class="prefix">&bull;</div>
  <div class="body">
    <div class="first-line"><a href="{{event.url}}" target="_blank">{{ event.name }}</a></div>
    <div class="second-line">
      <span class="segment" data-name="price">
      {%- if event.price == 'free' or event.price == 'FREE' -%}
        FREE
      {%- elsif event.price == 'vendors' -%}
        FREE + Vendors
      {%- elsif event.price -%}
        {%- if event.price.first -%}
          ${{ event.price.first }}-{{ event.price.last }}
        {%- elsif event.price contains "" -%}
          {{ event.price }}
        {%- elsif event.price == true -%}
          $
        {%- else -%}
          ${{ event.price }}
        {%- endif -%}
      {%- else -%}
        $?
      {%- endif -%}
      </span><span class="segment" data-name="location">{{ event.location }}</span>
      
      {%- if event.minage -%}
        <span class="segment" data-name="minage">ages {{ event.minage }}+</span>
      {%- endif -%}

      <span class="segment" data-name="when">
      {%- if event.when.first -%}
        {%- assign num_events = whens | size -%}
        {%- if num_events == 1 -%}
          {{ whens.first | date: "%a, %b %-d" }}
        {%- elsif num_events == 2 -%}
          {{ whens.first | date: "%a, %b %-d" }} and {{ whens.last | date: "%a, %b %-d" }}
        {%- else -%}
          {{ num_events }} times {{ whens.first | date: "%a, %b %-d" }}-{{ whens.last | date: "%a, %b %-d"}}
        {%- endif -%}
      {%- else -%}
        {{ event.when }}
      {%- endif -%}
      </span>

      {%- if event.partof -%}
        <span class="segment" data-name="partof">{{ event.partof }}</span>
      {%- endif -%}

      {%- if event.tags -%}
        <span class="segment tags" data-name="tags">{{ event.tags | sort | join: ', ' }}</span>
      {%- endif -%}
    </div>
  </div>
</div>