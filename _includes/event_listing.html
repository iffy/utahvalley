{%- assign time_start = include.start -%}

{%- assign order = 0 -%}
{%- assign whens = "" | split: "" -%}
{%- assign nwhens = "" | split: "" -%}
{%- if event.when.first -%}
  {%- for when in event.when -%}
    {%- assign nwhen = when | date: "%s" | plus: 0 -%}
    {%- if nwhen >= time_start -%}
      {%- assign whens = whens | push: when -%}
    {%- endif -%}
    {%- assign nwhens = nwhens | push: nwhen -%}
  {%- endfor -%}
  {%- for when in whens -%}
    {%- assign date = when | date: "%s" | plus: 0 -%}
    {%- if date >= time_start and (order == 0 or date < order) -%}
      {%- assign order = date -%}
    {%- endif -%}
  {%- endfor -%}
{%- endif -%}
<div class="listing" {% if event.when.first %}data-dates="{% for when in event.when %}{{ when | date: "%s" }} {% endfor %}"{% endif %} style="order: {{order}};" data-order="{{ order }}">
  <div class="prefix">&bull;</div>
  <div class="body">
    <div class="first-line"><a href="{{event.url}}" target="_blank">{{ event.name }}</a></div>
    <div class="second-line">
      {%- if include.showcal -%}
      <span class="segment" data-name="calendar">
        <div class="calendar">
          {%- for num in (0...6) -%}
          {%- assign seconds_after = num | times: 86400 -%}
          {%- assign thisday = time_start | plus: seconds_after -%}
          {%- assign nextday = thisday | plus: 86400 -%}
          <div class="{%- for nwhen in nwhens -%}
            {%- if (nwhen >= thisday) and (nwhen < nextday -%}included {% endif -%}
          {%- endfor -%}" date-date-marker="{{ thisday }}">{{ thisday | date: "%a" | truncate: 1, ''}}</div>
          {%- endfor -%}
        </div>
      </span>
      {%- endif -%}
      <span class="segment" data-name="price">
      {%- if event.price == 'free' or event.price == 'FREE' -%}
        FREE
      {%- elsif event.price == 'vendors' -%}
        FREE + Vendors
      {%- elsif event.price -%}
        {%- if event.price.first -%}
          ${{ event.price.first }}-{{ event.price.last }}
        {%- elsif event.price contains "" -%}
          {{ event.price }}
        {%- elsif event.price == true -%}
          $
        {%- else -%}
          ${{ event.price }}
        {%- endif -%}
      {%- else -%}
        $?
      {%- endif -%}
      </span><span class="segment" data-name="location">{{ event.location }}</span>
      
      {%- if event.minage -%}
        <span class="segment" data-name="minage">ages {{ event.minage }}+</span>
      {%- endif -%}

      <span class="segment" data-name="when">
      {%- if event.when.first -%}
        {%- assign num_events = whens | size -%}
        {%- if num_events == 1 -%}
          {{ whens.first | date: "%a, %b %-d" }}
        {%- elsif num_events == 2 -%}
          {{ whens.first | date: "%a, %b %-d" }} and {{ whens.last | date: "%a, %b %-d" }}
        {%- else -%}
          {{ num_events }} times {{ whens.first | date: "%a, %b %-d" }}-{{ whens.last | date: "%a, %b %-d"}}
        {%- endif -%}
      {%- else -%}
        {{ event.when }}
      {%- endif -%}
      </span>

      {%- if event.partof -%}
        <span class="segment" data-name="partof">{{ event.partof }}</span>
      {%- endif -%}

      {%- if event.tags -%}
        <span class="segment tags" data-name="tags">{{ event.tags | sort | join: ', ' }}</span>
      {%- endif -%}
    </div>
  </div>
</div>